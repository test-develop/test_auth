version: '3'

volumes:
  mysql_data:
      driver: local

networks:
  oidc_network:
    driver: bridge

services:
  public_web: #SPAサイト
    # dockerimageのファイルを指定
    build: ./public/web/

    # コンテナ名
    container_name: node_docker_app

    # 環境変数を設定
    environment:
      - DEBUG=app:*
      - CHOKIDAR_USEPOLLING=true

    tty: true
    
    # ホスト側のポート:コンテナのポート
    ports:
      - '3000:3000'

    # ソースコードを格納するフォルダをマウント
    #（ホスト側の./srcをコンテナの/appにマウント）
    volumes:
      - ../src/public/web:/app

    # 起動時のカレントフォルダを指定
    working_dir: /app

    # 起動後に実行するコマンドを指定(起動確認用）
    command: npm run dev

  mysql:
      image: mysql:5.7
      # コンテナ名
      container_name: mysql_with_keycloak

      volumes:
        - mysql_data:/var/lib/mysql
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: keycloak
        MYSQL_USER: keycloak
        MYSQL_PASSWORD: password
      networks:
        - oidc_network
        
  keycloak:
      image: quay.io/keycloak/keycloak:latest
      # コンテナ名
      container_name: keycloak

      environment:
        DB_VENDOR: MYSQL
        DB_ADDR: mysql
        DB_DATABASE: keycloak
        DB_USER: keycloak
        DB_PASSWORD: password
        KEYCLOAK_USER: admin
        KEYCLOAK_PASSWORD: password
        # Uncomment the line below if you want to specify JDBC parameters. The parameter below is just an example, and it shouldn't be used in production without knowledge. It is highly recommended that you read the MySQL JDBC driver documentation in order to use it.
        #JDBC_PARAMS: "connectTimeout=30000"
      ports:
        - 8080:8080
      depends_on:
        - mysql
      networks:
        - oidc_network
  
  saml_sp:
    build: ./private/saml_sp/
    # コンテナ名
    container_name: saml_sp
    ports:
    - 8081:80
    networks:
      - oidc_network